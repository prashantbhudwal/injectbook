name: Release

on:
  push:
    tags:
      - "v*"

jobs:
  build:
    runs-on: macos-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run checks
        run: |
          pnpm run check
          pnpm test

      - name: Build package
        run: pnpm run build:binary

      - name: Package CLI artifacts
        id: package
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          mkdir -p dist/release/arm64 dist/release/amd64

          cp dist/pkg/injectbook-arm64 dist/release/arm64/injectbook
          chmod +x dist/release/arm64/injectbook
          tar -C dist/release/arm64 -czf "dist/injectbook-v${VERSION}-darwin-arm64.tar.gz" injectbook

          cp dist/pkg/injectbook-x64 dist/release/amd64/injectbook
          chmod +x dist/release/amd64/injectbook
          tar -C dist/release/amd64 -czf "dist/injectbook-v${VERSION}-darwin-amd64.tar.gz" injectbook

          echo "arm64_file=dist/injectbook-v${VERSION}-darwin-arm64.tar.gz" >> "$GITHUB_OUTPUT"
          echo "amd64_file=dist/injectbook-v${VERSION}-darwin-amd64.tar.gz" >> "$GITHUB_OUTPUT"

      - name: Generate SHA256 values
        id: sha
        run: |
          ARM64_SHA=$(shasum -a 256 "${{ steps.package.outputs.arm64_file }}" | awk '{print $1}')
          AMD64_SHA=$(shasum -a 256 "${{ steps.package.outputs.amd64_file }}" | awk '{print $1}')
          echo "arm64_sha=$ARM64_SHA" >> "$GITHUB_OUTPUT"
          echo "amd64_sha=$AMD64_SHA" >> "$GITHUB_OUTPUT"

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ${{ steps.package.outputs.arm64_file }}
            ${{ steps.package.outputs.amd64_file }}

      - name: Print formula update hints
        run: |
          echo "Update Formula/injectbook.rb in your tap repo with:"
          echo "  Formula/injectbook.rb"
          echo "  arm64 url: https://github.com/${GITHUB_REPOSITORY}/releases/download/${GITHUB_REF_NAME}/$(basename '${{ steps.package.outputs.arm64_file }}')"
          echo "  arm64 sha256: ${{ steps.sha.outputs.arm64_sha }}"
          echo "  amd64 url: https://github.com/${GITHUB_REPOSITORY}/releases/download/${GITHUB_REF_NAME}/$(basename '${{ steps.package.outputs.amd64_file }}')"
          echo "  amd64 sha256: ${{ steps.sha.outputs.amd64_sha }}"
